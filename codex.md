# Codex instructions for ts_discord_bot

## 目的と対象
- 個人用 Discord Bot を TypeScript（ESM）と discord.js v14 で開発する。
- 開発環境は ArchLinux (Hyprland)、実行環境も同マシンを想定。

## 参照必須ドキュメント
以下の md を常に最優先で参照し、方針や仕様と矛盾する提案は避けること。必要に応じて該当箇所を引用して根拠を示す。
- `docs/design/bot_design.md`
- `docs/design/command_specs.md`
- `docs/design/data_structure.md`
- `docs/design/dir_structure.md`
- `docs/design/log_design.md`
- `docs/quality/coding_guidelines.md`
- `docs/quality/testing_strategy.md`

## コーディング規約と命名
- TypeScript + ESM を厳守し、`package.json` の `"type": "module"` に従う。
- 変数・関数・クラスなど命名は**全て snake_case**で統一する。discord.js 等の外部 API 名は既存命名を尊重する。
- コマンド実装は `features/<name>/command.ts`、ビジネスロジックは `service.ts` に集約し、DB への直接アクセスは禁止。DB は `storage/` 配下および `repo.ts` を経由する。
- ログは `src/core/logger.ts` を使用して `logs/` 配下に出力する。
- Jest でテストを書き、必要に応じてテストコード案も提示する。

## コメントとドキュメンテーション
- クラス・メソッド・関数・変数ごとに「役割／入力／出力」をコメントで明記する。
- 可能な限り処理単位（1 行ごと）で補足コメントを入れ、コードレビュー時に処理内容が追いやすい状態にする。冗長でもよいので詳細に書く。
- コメントや説明文は基本的に日本語。固有名詞・API 名は英語のままでよい。

## ワークフロー
1. **設計共有**: コーディング前に、目的・対応範囲・主要なアルゴリズム・データ構造・入出力仕様・影響範囲を文章で提示し、ユーザーの承認を得る。
2. **ユーザー主導の実装**: 原則としてファイル編集はユーザーが行う。Codex は案内・疑問点解消・レビュー・テスト方針提示に専念する。
3. **レビュー**: ユーザー実装後は差分を確認し、命名・コメント方針・docs の方針遵守状況・型安全性などを中心にレビューし、必要な修正を指摘する。
4. **改善提案**: 既存ドキュメントと矛盾しない改善案があれば提案する。ただし実際の修正は必ずユーザー承認後に行う。

## 出力スタイル
- すべて日本語で回答すること。
- コード例を提示する場合は、できる限りファイル全体を 1 つのコードブロックで示し、行コメントで意図を説明する。
- レスポンスでは「何を実施したか」「未実施の理由」「次のアクション」を簡潔に記載する。

## 原則・禁止事項
- docs 配下および本 `codex.md` に反する行為は禁止。迷う場合は必ず質問する。
- ユーザーに無断で仕様変更・アーキテクチャ変更・追加ライブラリ導入をしない。
- ボットのコアロジックは TypeScript で書き、不要な自動生成や過度な抽象化は避ける。
- 設計やレビューで不明点があれば、推測で進めず必ず確認を取る。
