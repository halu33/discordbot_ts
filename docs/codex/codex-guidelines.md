# Codex 開発支援ガイド

`codex.md` の詳細版として、Codex がこのプロジェクトを支援する際に参照すべきルール・ワークフロー・テンプレートをまとめる。

## 1. 目的と前提
- 個人用 Discord Bot を TypeScript（ESM）+ discord.js v14 で開発する。
- 開発・実行環境ともに ArchLinux (Hyprland)。ローカル常時稼働を前提に設計する。
- `codex.md` と `docs/` 配下の各設計書・品質ガイドラインに明記された内容を最優先で尊重する。

## 2. 参照必須ドキュメント
常に最新の情報源として以下を参照し、根拠が必要な場合は該当ドキュメント名と章を明示する。
- `docs/design/bot_design.md` … 全体構成と基本思想
- `docs/design/command_specs.md` … Slash コマンド仕様
- `docs/design/data_structure.md` … DB・ログ構造
- `docs/design/dir_structure.md` … src 配下の責務
- `docs/design/log_design.md` … ログポリシー
- `docs/quality/coding_guidelines.md` … 命名・実装規約
- `docs/quality/testing_strategy.md` … テスト戦略
- 本ドキュメントおよびルートの `codex.md`

## 3. コーディング規約と命名
- TypeScript + ESM を厳守し、`package.json` の `"type": "module"` に従う。
- 変数・関数・クラス・ファイル名などプロジェクト内の命名は **snake_case** で統一する（外部 API 名は既存命名を尊重）。
- コマンド実装: `src/features/<機能名>/command.ts`
- ビジネスロジック: 同階層の `service.ts` に集約し、副作用を持たない純粋な処理を目指す。
- DB アクセス: `storage/` 配下および `repo.ts` を経由し、service 層から直接 DB へアクセスしない。
- ログ出力: `src/core/logger.ts` を通して `logs/` ディレクトリに書き込む。
- テスト: Jest を使用し、service 層のテストを基本とする。必要に応じてモック戦略を明記する。

## 4. コメントとドキュメンテーション
- **クラス／メソッド／関数／変数ごとに** 目的・入力・出力をコメントで説明する。
- 可能な限り処理単位（1 行レベル）で補足コメントを残し、意図・例外・副作用を明示する。
- コメント・説明文・ログ案は日本語で記述し、TypeScript 型や API 名など固有名詞は英語のまま使用してよい。
- コード例を提示する際はファイル全体を1つのコードブロックにまとめ、行コメントで意図を説明する。

## 5. ワークフロー
1. **設計共有**  
   - コーディング前に、目的・前提・処理フロー・データ構造・入出力・影響範囲をテキストで提示する。  
   - 参考テンプレ:
     ```
     ### 目的
     - 何を解決するための変更か
     
     ### 対応範囲
     - 追加／更新するファイル、作成するコマンド名など
     
     ### 処理概要
     - 入力
     - 出力
     - 主なアルゴリズムまたはステップ
     
     ### 影響範囲・懸念
     - 影響が及ぶモジュールやテスト
     - 想定されるリスク
     ```
   - ユーザーの承認を得てから次のステップへ進む。
2. **ユーザー主導の実装**  
   - 原則としてファイル編集はユーザーが行う。Codex は助言・疑問解消・サンプル提示（必要最小限）にとどめる。
3. **レビュー**  
   - ユーザー実装後の差分を確認し、命名・コメント・docs 準拠・型安全性・テスト有無などをチェックする。
   - 指摘は具体的なファイル名と行番号を付け、修正案があれば提案する。
4. **改善提案**  
   - 追加の改善やリファクタ提案がある場合は、必ずユーザーの意向を確認してから進める。

## 6. 出力スタイル
- すべて日本語で回答し、設計判断の理由や根拠を添える。
- レスポンス構成の推奨:
  1. 対応内容（何を実施したか、何を実施していないか）
  2. 根拠／参照ドキュメント
  3. 次のアクションまたは質問
- 複数案を提示する場合は比較がしやすいよう表や箇条書きで利点・欠点を整理する。

## 7. 禁止事項と判断基準
- `docs/` 配下や本ガイドに反する提案・実装支援を行わない。
- ユーザーの承認なしに仕様変更・依存追加・アーキテクチャ改変をしない。
- 推測で仕様を埋めず、疑問があれば必ず質問する。
- コード生成時に snake_case 以外の命名やコメント欠落がないか自らチェックする。

## 8. レビュー観点チェックリスト
- 命名: snake_case、ドメイン用語の整合性
- 責務: features/service/storage の役割分離が守られているか
- コメント: 役割・入出力・行コメントが十分か
- 例外処理: 想定外パスのハンドリング、ログ出力の有無
- テスト: 必要なケースがカバーされているか、モック方針が明確か
- ドキュメント整合: 対象設計書に矛盾がないか
