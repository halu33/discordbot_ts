# 機能仕様書（command_specs）

## 共通ポリシー
- **基本は MySQL DB を利用**し、メモ・ToDo・Clip などの常用機能はすべて DB 永続化する。TypeScript 内部メモリは一時バッファや非同期保存待ちのキャッシュ用途に限定する。
- DB への書き込みでエラーが発生した場合は、エラー通知チャンネルへ詳細を投稿し、ユーザーへも通知する。
- Bot を使う会話チャンネルは複数設定可能とし、さらに「設定専用チャンネル」「エラーレポートチャンネル」を別途設定できる。
- Slash Command と通常メッセージの両方に対応する。自然言語フローが存在する機能は、Slash Command を補助導線として維持する。
- 応答は必ず日本語で、成功・失敗ともにユーザーが直感的に理解できる文章を返す。
- テストしやすいよう、ビジネスロジックは service 層関数に分離し、副作用はアダプタ層に限定する。

---

## 0. 動作チャンネルと会話フロー

### 0-1. チャンネル設定
- `config.active_channel_ids`（アレイ）を持ち、Bot と会話するチャンネルを複数登録可能にする。管理コマンドまたは自然言語（例:「このチャンネルも Bot が反応するようにして」）で追加・削除を行う。
- `config.setting_channel_id`: 設定変更やメンテ用の専用チャンネル。ここでは静的な設定コマンドのみ受け付ける。
- `config.error_channel_id`: DB エラーや連携失敗などを通知するチャンネル。通常会話では使わない。
- Bot は会話チャンネル内のメッセージを解析し、設定チャンネルではコマンドのみ受け付け、その他のチャンネルでは反応しない。

### 0-2. メッセージ解析ルール
- 正規表現ベースのキーワードマッチで意図を推測する（例: `/todo add` 相当 → `/(todo|やること).*(登録|追加)/`）。
- 複数候補が出た場合は「ToDo として登録しますか？メモにしますか？」のように確認ダイアログを返す。
- フロー中の一時的な状態（例: クリップ追加中の質問待ち）は `conversation_state` に保持し、60 秒などのタイムアウトで破棄する。ただし未入力項目があっても登録自体は進め、欠落部分は空欄（null）として扱う。

### 0-3. Slash Command
- すべての機能に Slash Command を残し、会話フローで失敗した場合のフォールバックルートを確保する。
- Slash Command は後述の仕様テーブルで定義する。自然言語対応がある場合は「自然言語トリガー」欄に例を記載する。

---

## 1. 記録・整理機能

### 1-1. メモ（`/memo`）
- **目的**: すぐに記録したい短文メモを追加し、必要に応じて一覧表示・削除する。
- **データ構造（メモリ）**: `memos: Array<{ id: number; text: string; created_at: Date; }>`。ID は通し番号。
- **自然言語トリガー例**: 「メモして」「○○をメモ」「さっきのメモを見せて」。

| 操作 | Slash | 入力 | 出力 | エラーハンドリング |
|------|-------|------|------|----------------------|
| 追加 | `/memo add text:<string>` | text | `✅ メモを登録しました (#id)` | 空文字は拒否し `テキストを入れてください` |
| 一覧 | `/memo list limit:<int?>` | limit | 最新順で `limit` 件 | データ未登録時は `メモはまだありません` |
| 全削除 | `/memo clear confirm:true` | confirm | `🗑 N件削除` | confirm 不在は確認文を返す |
| 会話 | なし | 発話内容 | Bot が「登録しますね」と確認後追加 | 途中でキャンセルなら `了解、取り消しました` |

### 1-2. ToDo（`/todo`）
- **目的**: 簡単なタスク管理。優先度や期日は後回し。完了／未完を切り替える。
- **データ構造**: `todos: Array<{ id: number; text: string; status: "open"|"done"; created_at: Date; done_at?: Date; }>`。
- **並び順**: `created_at ASC`（昇順）、同一時刻なら ID 昇順。
- **自然言語トリガー例**: 「todo に○○追加」「未完の todo 教えて」「todo 3 番終わった」。

| 操作 | Slash | 入力 | 出力 | エラーハンドリング |
|------|-------|------|------|----------------------|
| 追加 | `/todo add text` | text | `✅ ToDo を追加 (#id)` | 既存と同一内容でも追加可。空は拒否 |
| 完了 | `/todo done id` | id | `✅ ToDo #id を完了` | ID 不存在 → `該当 ToDo が見つかりません` |
| 一覧 | `/todo list filter` | `filter = open/done/all` | 行番号付きテキスト or embed | データなし → `該当する ToDo はありません` |
| 会話 | なし | 例:「router 再起動を todo に追加して」 | フォーム入力→確認 | 候補不明なら何を登録するか聞き直す |

### 1-3. クリップ（`/clip`）
- **目的**: URL をポストした際に Bot が拾って保存し、タグや説明を付けて整理する。
- **データ構造**: `clips: Array<{ id; url; title; note; tags: string[]; added_at; }>`。title/note は会話で質問。
- **自然言語トリガー**:
  - URL を単体で送信 → Bot が「この URL のタイトルは？タグは？」と順に聞く。
  - 「クリップ一覧」「shop タグの URL 教えて」などで一覧表示。
- **Slash Command** は後方互換用に保持。

| 操作 | Slash | 入力 | 出力 |
|------|-------|------|------|
| 追加 | `/clip add url/tag/note` | URL/タグ/メモ | `🔖 クリップしました` |
| 一覧 | `/clip list tag` | tag? | embed で URL/タグ/メモ表示 |
| 会話 | なし | URL 投稿 | Bot が `タイトルを教えてください`→`タグは？`→登録結果報告 |
| 検索 | `/clip search keyword`(将来) | keyword | 含まれるクリップを抜粋 |

- **エラーハンドリング**: 不正 URL は `有効なURLではありません`。会話途中で 60 秒無反応ならキャンセル。

### 1-4. アイデア（`/idea`）
- メモより長期的なアイデア保管。タグ分類を重視。
- **自然言語トリガー**: 「アイデアメモ」「○○の案思いついた」→登録。「ランダムなアイデア」「○○タグのアイデア」→一覧。

| 操作 | Slash | 入力 | 出力 |
|------|-------|------|------|
| 追加 | `/idea add text tag?` | text, tag? | `💡 登録しました (#id)` |
| 一覧 | `/idea list tag mode` | tag?, mode(`latest/random`) | 指定形式で表示 |
| 会話 | なし | 発話→確認→登録 | 長文の場合は embed で折り返し |

### 1-5. 日誌ログ（`/log`）
- **用途**: `/daily` `/weekly` の元データ。気分スコア・本文を記録。
- **自然言語トリガー**: 「今日の出来事登録」「さっきの作業、普通だった」など。

| 操作 | Slash | 入力 | 出力 |
|------|-------|------|------|
| 追加 | `/log add rating? text` | rating 0-5, text | `📝 ログを追加` |
| 一覧 | `/log list range` | `range` = today / yesterday / 7d | 指定期間のログを整形表示 |
| 会話 | なし | 例:「今日の出来事: ...」 | rating の有無を聞く→登録結果 |

- **エラーハンドリング**: rating が数値外 → `0〜5で入力してください`。本文欠如で拒否。

---

## 2. 作業・状態管理

### 2-1. セッション（`/session`）
- **目的**: 作業開始・終了の記録と、任意タイマー通知（ポモドーロ的）を提供。
- **データ構造**: `sessions: Array<{ id; name; started_at; ends_at?; duration_min?; status: "active"|"ended"; }>`。
- **自然言語トリガー**: 「作業始める」「○○を30分」「作業終わった」「今のセッション状況は？」。

| 操作 | Slash | 入力 | 出力 |
|------|-------|------|------|
| 開始 | `/session start name? duration?` | name?, duration(分)? | `▶️ セッション開始 (終了予定 HH:MM)` |
| 終了 | `/session end` | - | `⏹ セッション終了。合計XX分` |
| 状態 | `/session status` | - | 進行中なら残り時間/経過時間、未実行なら`現在は稼働していません` |
| 会話 | なし | 「作業開始」「○○を1時間」 | 引数確認→登録 |

- **タイマー通知**: duration を設定した場合、終了5分前と終了時にメンション付きで通知。duration 未指定なら通知なし。
- **エラー**: 既に進行中に start → `実行中のセッションがあります`。end 時に進行中がない → `終了できるセッションがありません`。

### 2-2. 平常ステータス（`/status`）
- Bot のプレゼンス/ステータス文を設定。

| 操作 | Slash | 入力 | 出力 |
|------|-------|------|------|
| 設定 | `/status set text` | text | `🟢 ステータスを更新しました` |
| 表示 | `/status show` | - | 現在のステータス文 |
| 会話 | 「今のステータスは？」等 | - | Slash と同じ |

---

## 3. サマリ・定期投稿

### 3-1. 日次サマリ（`/daily` + 自動投稿）
- **コンテンツ案**: 当日の ToDo（open）、最新メモ３件、セッション進行中、天気/予定は将来連携。
- **自然言語**: 「今日のサマリ」「今日日報ちょうだい」。

| 操作 | Slash | 入力 | 出力 |
|------|-------|------|------|
| 生成 | `/daily now` | - | embed: ToDo/ログ/メモなど |  |
| 自動 | cron | config.daily_time | 指定チャンネルに投稿 |

- **エラー**: データなしの場合は「該当データなし」のセクションを灰色表示。

### 3-2. 週次サマリ（`/weekly`）
- **内容**: 直近 7 日のログ数、セッション累計時間、完了 ToDo 件数。
- **自然言語**: 「今週まとめ」「週報」。
- cron で `config.weekly_day` + `daily_time` に投稿。

### 3-3. 朝の情報定期投稿（新規）
- **目的**: 毎朝決まった時間に、以下の情報をまとめて投稿し、一日の計画や気分の指針になるようにする。
  1. 日時・曜日・天気（将来 API 連携予定。現状は手入力/固定文）
  2. 今日の予定（ToDo やセッション予約などから引用）
  3. 残っているタスク（未完了 ToDo の概要）
  4. トレンド情報（将来的にニュース/トレンド API から見出し 5〜10 件を取得）
  5. 今日の一言（将来的に Markov 連鎖等から生成）
- **その他候補**: 気温/降水確率、リマインダー（例: ゴミ出し）、Kiss FM 連携でのおすすめ番組など。必要に応じて追加する。
- **設定**: `config.morning_digest_time`, `config.morning_digest_channel_id` に加え、各情報ソースの有効/無効フラグや API キーを保持する想定。
- **自然言語**: 「朝の定期投稿設定して」「朝の情報を○○時に送って」「今日の予定と天気をまとめて」。
- **当面の実装**: 天気・トレンドはダミーデータまたは手入力で対応し、後から外部連携に置き換える。

### 3-4. 野球情報速報（将来）
- **目的**: プロ野球（特に阪神）、高校野球、MLB/大学野球の主要ニュースを収集し、重要な更新を通知する。
- **入力ソース**: 球団公式サイト、NPB公式、阪神公式SNS、高校野球ニュースサイト、スポーツAPIなど。将来的に RSS/スクレイピング/API を組み合わせる。
- **通知チャネル**: `config.baseball_news_channel_id` を設定し、速報はここへ投稿。会話チャンネルで「阪神の最新情報」「甲子園の結果は？」など聞かれた場合にも回答できるようにする。
- **優先度**: 阪神タイガース関連を最優先で拾う。次にプロ野球全般、高校野球、MLB/大学野球の順。
- **将来的な機能**:
  - 「次の試合はいつ？」などの日程問い合わせ。
  - 球団ごとのスタメン・結果まとめ。
  - ニュースのハイライトを5件程度でまとめ、朝の情報定期投稿に含めることも検討。
- **実装方針**: 当面は手動登録または外部APIを取得する service を設計し、DB の `baseball_news` テーブルへ格納。定期ジョブで新着をチェックし、既知のニュースとの重複を避ける。

---

## 4. 設定管理（`/config` + 会話）

- **保持項目**: `active_channel_id`, `daily_time`, `weekly_day`, `morning_digest_time`, `timezone` など。当面はメモリ上の `config` オブジェクトで管理。
- **操作手順**:
  - 「今の設定を教えて」で全設定を embed 表示。
  - 「朝の投稿時間を7時に」「このチャンネルを操作用に」など自然言語で変更要求 → Bot が確認。
- **Slash**:

| 操作 | Slash | 入力 | 出力 |
|------|-------|------|------|
| 取得 | `/config show` | - | 全設定を表形式で表示 |
| 個別取得 | `/config get key` | key | 指定値 | 不明 key → `存在しません` |
| 設定 | `/config set key value` | key, value | `設定を更新しました` | バリデーション失敗時に理由提示 |

- **エラーハンドリング**: 型不一致（例: 時刻形式でない）→ `HH:mm 形式で指定してください`。未知の設定 → `設定項目が存在しません`。

---

## 5. 将来の拡張

- **Kiss FM KOBE 連携**: `/kissfm schedule`, `/kissfm now_playing`、朝の番組表自動投稿などは拡張セクションで別途設計。外部サイトからのスクレイピング/API 利用、キャッシュ戦略が必要。
- **天気・予定 API 連携**: OpenWeather やカレンダーと連携し、朝の定期投稿や自然言語問い合わせ（「今の天気は？」）に回答できるようにする。
- **野球情報集約**: プロ野球/高校野球/MLB/大学野球のニュース取得、球団公式情報の優先監視、自然言語問い合わせ対応。
- **Markov 連鎖発話**: MeCab で解析した会話ログを MySQL に保存し、学習データをもとに Markov 連鎖で文章を生成。朝の「今日の一言」や日中の雑談に活用する。
- **ノートアプリ連携**: Notion/Google Sheets への同期機能もここで管理し、データの二重管理を避ける。

---

## 6. 例外処理ガイドライン

- すべての機能で例外時ログを残しつつ、ユーザーにはフレンドリーなメッセージを返す（例: `処理に失敗しました。少し時間をおいて再度お試しください。`）。
- 会話フロー中に Bot が意図を理解できない場合は「○○として登録しますか？」と選択肢を提示し、曖昧なまま処理を進めない。
- 定期投稿が失敗した場合は `logger` に詳細を記録し、操作チャンネルへ失敗通知を送る。

---

## 7. 参考実装メモ

- すべてのデータストアは当面 `src/features/<name>/memory_store.ts` のようなモジュールに分離し、将来的に DB を導入するときに差し替えられる形にしておく。
- 会話状態管理は `conversation_state` マップにユーザー ID（現状は自分のみ）をキーとして保存。タイムアウトは `setTimeout` 管理。
- Slash Command のレスポンスは ephemeral ではなく公開メッセージ（自分専用サーバー前提）でよい。
